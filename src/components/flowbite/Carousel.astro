---
/**
 * Flowbite Carousel Component
 *
 * A reusable, accessible carousel/slider component using Flowbite's TypeScript API.
 * Supports auto-sliding, keyboard navigation, indicators, and prev/next controls.
 *
 * @example
 * ```astro
 * <Carousel>
 *   <div>Slide 1 content</div>
 *   <div>Slide 2 content</div>
 *   <div>Slide 3 content</div>
 * </Carousel>
 * ```
 *
 * @example With images
 * ```astro
 * <Carousel interval={5000} showIndicators={true}>
 *   <img src="/image1.jpg" alt="First" />
 *   <img src="/image2.jpg" alt="Second" />
 * </Carousel>
 * ```
 *
 * @see https://flowbite.com/docs/components/carousel/#typescript
 */

interface Props {
  /** Auto-slide interval in milliseconds. Set to 0 to disable auto-sliding. */
  interval?: number;
  /** Which slide to show first (0-indexed). */
  defaultPosition?: number;
  /** Show dot indicators below the carousel. */
  showIndicators?: boolean;
  /** Show prev/next arrow controls. */
  showControls?: boolean;
  /** Additional CSS classes for the carousel container. */
  class?: string;
  /** Height of the carousel. Can be any valid CSS value. */
  height?: string;
  /** Unique ID for the carousel. Auto-generated if not provided. */
  id?: string;
}

const {
  interval = 0,
  defaultPosition = 0,
  showIndicators = true,
  showControls = true,
  class: className = "",
  height = "16rem",
  id,
} = Astro.props;

// Generate a unique ID for this carousel instance
const carouselId = id || `carousel-${Math.random().toString(36).slice(2, 9)}`;
---

<div
  id={carouselId}
  class:list={["flowbite-carousel relative w-full", className]}
  data-carousel-interval={interval}
  data-carousel-default-position={defaultPosition}
  role="region"
  aria-roledescription="carousel"
  aria-label="Image carousel"
>
  <!-- Carousel wrapper -->
  <div
    class="carousel-viewport relative overflow-hidden rounded-lg"
    style={`height: ${height};`}
  >
    <div class="carousel-track">
      <slot />
    </div>
  </div>

  <!-- Indicators -->
  {
    showIndicators && (
      <div
        class="carousel-indicators absolute bottom-4 left-1/2 z-30 flex -translate-x-1/2 space-x-3 rtl:space-x-reverse"
        role="tablist"
      />
    )
  }

  <!-- Controls -->
  {
    showControls && (
      <>
        <button
          type="button"
          class="carousel-prev group absolute start-0 top-0 z-30 flex h-full cursor-pointer items-center justify-center px-4 focus:outline-none"
          aria-label="Previous slide"
        >
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/30 group-hover:bg-white/50 group-focus:outline-none group-focus:ring-4 group-focus:ring-white dark:bg-gray-800/30 dark:group-hover:bg-gray-800/60 dark:group-focus:ring-gray-800/70">
            <svg
              class="h-4 w-4 text-white rtl:rotate-180 dark:text-gray-800"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 6 10"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 1 1 5l4 4"
              />
            </svg>
          </span>
        </button>
        <button
          type="button"
          class="carousel-next group absolute end-0 top-0 z-30 flex h-full cursor-pointer items-center justify-center px-4 focus:outline-none"
          aria-label="Next slide"
        >
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/30 group-hover:bg-white/50 group-focus:outline-none group-focus:ring-4 group-focus:ring-white dark:bg-gray-800/30 dark:group-hover:bg-gray-800/60 dark:group-focus:ring-gray-800/70">
            <svg
              class="h-4 w-4 text-white rtl:rotate-180 dark:text-gray-800"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 6 10"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m1 9 4-4-4-4"
              />
            </svg>
          </span>
        </button>
      </>
    )
  }
</div>

<script>
  import { Carousel } from "flowbite";
  import type { CarouselItem, CarouselOptions, IndicatorItem } from "flowbite";

  function initCarousels() {
    const carousels = document.querySelectorAll<HTMLElement>(".flowbite-carousel");

    carousels.forEach((carouselEl) => {
      // Skip if already initialized
      if (carouselEl.dataset.initialized === "true") return;

      const track = carouselEl.querySelector<HTMLElement>(".carousel-track");
      const indicatorsContainer = carouselEl.querySelector<HTMLElement>(".carousel-indicators");
      const prevButton = carouselEl.querySelector<HTMLElement>(".carousel-prev");
      const nextButton = carouselEl.querySelector<HTMLElement>(".carousel-next");

      if (!track) return;

      // Get all direct children of the track as slides
      const slideElements = Array.from(track.children) as HTMLElement[];
      if (slideElements.length === 0) return;

      // Wrap each slide and build items array
      const items: CarouselItem[] = slideElements.map((child, index) => {
        // Wrap the child in a carousel-item container if not already
        if (!child.classList.contains("carousel-slide")) {
          const wrapper = document.createElement("div");
          wrapper.className = "carousel-slide absolute inset-0 transition-opacity duration-700 ease-in-out";
          wrapper.setAttribute("role", "tabpanel");
          wrapper.setAttribute("aria-label", `Slide ${index + 1} of ${slideElements.length}`);
          child.parentNode?.insertBefore(wrapper, child);
          wrapper.appendChild(child);

          // Center images by default
          if (child.tagName === "IMG") {
            child.classList.add(
              "absolute",
              "block",
              "w-full",
              "h-full",
              "object-cover",
              "left-0",
              "top-0"
            );
          }

          return { position: index, el: wrapper };
        }
        return { position: index, el: child };
      });

      // Create indicator buttons dynamically
      const indicatorItems: IndicatorItem[] = [];
      if (indicatorsContainer) {
        items.forEach((_, index) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "carousel-indicator h-3 w-3 rounded-full";
          button.setAttribute("role", "tab");
          button.setAttribute("aria-label", `Go to slide ${index + 1}`);
          button.setAttribute("aria-selected", index === 0 ? "true" : "false");
          indicatorsContainer.appendChild(button);
          indicatorItems.push({ position: index, el: button });
        });
      }

      // Read options from data attributes
      const interval = parseInt(carouselEl.dataset.carouselInterval || "0", 10);
      const defaultPosition = parseInt(carouselEl.dataset.carouselDefaultPosition || "0", 10);

      // Configure carousel options
      const options: CarouselOptions = {
        defaultPosition: Math.min(defaultPosition, items.length - 1),
        interval: interval > 0 ? interval : undefined,
        indicators: indicatorItems.length > 0
          ? {
              activeClasses: "bg-white",
              inactiveClasses: "bg-white/50 hover:bg-white",
              items: indicatorItems,
            }
          : undefined,
        onNext: () => updateAriaStates(),
        onPrev: () => updateAriaStates(),
        onChange: () => updateAriaStates(),
      };

      // Create the carousel instance
      const carousel = new Carousel(carouselEl, items, options);

      // Update ARIA states for accessibility
      function updateAriaStates() {
        const activeItem = carousel.getActiveItem();
        if (!activeItem) return;

        // Update slides
        items.forEach((item) => {
          const isActive = item.position === activeItem.position;
          item.el.setAttribute("aria-hidden", (!isActive).toString());
        });

        // Update indicators
        indicatorItems.forEach((indicator) => {
          const isActive = indicator.position === activeItem.position;
          indicator.el.setAttribute("aria-selected", isActive.toString());
        });
      }

      // Wire up prev/next buttons
      prevButton?.addEventListener("click", () => carousel.prev());
      nextButton?.addEventListener("click", () => carousel.next());

      // Wire up indicator buttons
      indicatorItems.forEach((indicator) => {
        indicator.el.addEventListener("click", () => carousel.slideTo(indicator.position));
      });

      // Keyboard navigation
      carouselEl.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") {
          e.preventDefault();
          carousel.prev();
        } else if (e.key === "ArrowRight") {
          e.preventDefault();
          carousel.next();
        }
      });

      // Pause on hover/focus for accessibility
      if (interval > 0) {
        carouselEl.addEventListener("mouseenter", () => carousel.pause());
        carouselEl.addEventListener("mouseleave", () => carousel.cycle());
        carouselEl.addEventListener("focusin", () => carousel.pause());
        carouselEl.addEventListener("focusout", () => carousel.cycle());
      }

      // Mark as initialized
      carouselEl.dataset.initialized = "true";

      // Initialize ARIA states
      updateAriaStates();

      // Start cycling if interval is set
      if (interval > 0) {
        carousel.cycle();
      }
    });
  }

  // Initialize on page load
  initCarousels();

  // Re-initialize after Astro page transitions
  document.addEventListener("astro:page-load", initCarousels);
</script>

<style>
  .carousel-track {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .carousel-slide {
    opacity: 0;
    z-index: 0;
  }

  .carousel-slide.active,
  .carousel-slide[data-active="true"] {
    opacity: 1;
    z-index: 20;
  }

  /* Ensure the carousel is focusable for keyboard navigation */
  .flowbite-carousel:focus {
    outline: 2px solid rgb(59 130 246);
    outline-offset: 2px;
  }

  .flowbite-carousel:focus:not(:focus-visible) {
    outline: none;
  }
</style>
